<%- include('../partials/header') %>
<style>
     .order-details {
        max-width: 1000px;
        margin: auto;
    }
    .table th, .table td {
        vertical-align: middle;
    }
    .text-primary {
        color: #007bff !important;
    }
    .bg-light {
        background-color: #f8f9fa !important;
    }
      .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
    body {
        background-color: #f8f9fa;
        color: #333;
    }
    .order-details {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    .card {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }
    .card:hover {
        transform: translateY(-5px);
    }
    .card-header {
        background-color: #007bff;
        color: white;
        font-weight: bold;
    }
    .table th {
        background-color: #f1f3f5;
    }
    .product-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
    }
    .text-primary {
        color: #007bff !important;
    }
    .btn-retry {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.2rem;
    }
    .btn-retry:hover {
        background-color: #c82333;
    }
</style>
<div class="colorlib-loader"></div>

    <div id="page">
        <nav class="colorlib-nav" role="navigation">
            <div class="top-menu">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-7 col-md-9">
                            <div id="colorlib-logo"><a href="/home">EYEGAZE</a></div>
                        </div>
                
                    </div>
                    <!-- <div class="row">
                        <div class="col-sm-12 text-left menu-1">
                            <ul>
                                <li><a href="index.html">Home</a></li>
                                <li class="has-dropdown active">
                                    <a href="men.html">Men</a>
                                    <ul class="dropdown">
                                        <li><a href="product-detail.html">Product Detail</a></li>
                                        <li><a href="cart.html">Shopping Cart</a></li>
                                        <li><a href="checkout.html">Checkout</a></li>
                                        <li><a href="order-complete.html">Order Complete</a></li>
                                        <li><a href="add-to-wishlist.html">Wishlist</a></li>
                                    </ul>
                                </li>
                                <li><a href="women.html">Women</a></li>
                                <li><a href="about.html">About</a></li>
                                <li><a href="contact.html">Contact</a></li>
                                <li class="cart"><a href="cart.html"><i class="icon-shopping-cart"></i> Cart [0]</a>
                                </li>
                            </ul>
                        </div>
                    </div> -->
                </div>
            </div>
            <div class="sale">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-8 offset-sm-2 text-center">
                            <div class="row">
                                <div class="owl-carousel2">
                                    <div class="item">
                                        <div class="col">
                                            <h3><a href="#">25% off (Almost) Everything! Use Code: Summer Sale</a></h3>
                                        </div>
                                    </div>
                                    <div class="item">
                                        <div class="col">
                                            <h3><a href="#">Our biggest sale yet 50% off all summer shoes</a></h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
<!-- nav end here -->
<div class="breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col">
                <p class="bread"><span><a href="/orders">orders</a></span> / <span>Purchase Complete</span></p>
            </div>
        </div>
    </div>
</div>

<div class="colorlib-product">
    <div class="container">
       
        <div class="row">
          
    <!------------------------------------------------------------------------------ ejs content start form here------------------------------------------------------------------------------------------------------------------          -->
                <!-- Order Details Section -->
                <div class="order-details mt-5">
                    <h1 class="text-center mb-5">Order Details</h1>
                    <div class="row">
                        <!-- Address Section -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h4 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Shipping Address</h4>
                                </div>
                                <div class="card-body">
                                    <address>
                                        <strong class="d-block mb-2"><%= addressdata.addressName %></strong>
                                        <%= addressdata.addressHouse %> <%= addressdata.addressStreet %>, <%= addressdata.addressPost %><br>
                                        <%= addressdata.addressCity %><br>
                                        <%= addressdata.addressDistrict %>, <%= addressdata.addressState %> - <%= addressdata.addressPin %><br>
                                        <i class="fas fa-phone-alt text-secondary me-2"></i> <%= addressdata.addressMobile %><br>
                                        <i class="fas fa-envelope text-secondary me-2"></i> <%= addressdata.addressEmail %>
                                    </address>
                                </div>
                            </div>
                        </div>
            
                        <!-- Order Summary -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h4 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Order Summary</h4>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li class="mb-2 d-flex justify-content-between align-items-center">
                                            <span class="text-muted">Order ID:</span>
                                            <strong>#<%= order.orderId %></strong>
                                        </li>
                                        <li class="mb-2 d-flex justify-content-between align-items-center">
                                            <span class="text-muted">Order Date:</span>
                                            <strong><%= order.orderDate.toISOString().split('T')[0] %></strong>
                                        </li>
                                        <li class="mb-2 d-flex justify-content-between align-items-center">
                                            <span class="text-muted">Payment Method:</span>
                                            <strong><%= order.paymentMethod %></strong>
                                        </li>
                                        <li class="mb-2 d-flex justify-content-between align-items-center">
                                            <span class="text-muted">Payment Status:</span>
                                            <% if (order.paymentStatus === 'Failed') { %>
                                                <span class="text-danger"><strong>Failed</strong></span>
                                            <% } else { %>
                                                <span class="text-success"><strong>Successful</strong></span>
                                            <% } %>
                                        </li>
                                        <% if (order.paymentStatus === 'Failed') { %>
                                            <li class="mt-3 text-center">
                                                <button  class="btn btn-danger btn-sm" onclick="retry_payment('<%= order.orderId %>')">
                                                    <i class="fas fa-sync-alt me-1"></i> Retry Payment
                                                </button>
                                            </li>
                                        <% } %>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
            
                    <!-- Product Table -->
                    <div class="card mt-5">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="fas fa-box-open me-2"></i>Ordered Products</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Image</th>
                                            <th>Product</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                            <th>discount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% order.products.forEach(an => { %>
                                            <tr>
                                                <td><img src="/productimage/<%= an.productId.productimages[0] %>" alt="Product Image" class="product-img rounded"></td>
                                                <td><%= an.productId.productName %></td>
                                                <td><%= an.quantity %></td>
                                                <td>&#8377;<%= an.price.toFixed(2) %></td>
                                                <td>&#8377;<%= (an.quantity * an.price).toFixed(2) %></td>
                                                <% if (an.product_discount> 0) { %>
                                                <td><%=an.product_discount%></td>
                                                <% } else { %>
                                                    <td>00</td>
                                                    <% } %> 
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                                            <td><strong>&#8377;<%= order.totalAmount.toFixed(2) %></strong></td>
                                        </tr>
                                        <tr>
                                            <td colspan="4" class="text-end"><strong>Shipping:</strong></td>
                                            <td><strong>&#8377;0.00</strong></td>
                                        </tr>
                                        <% if (order.discountAmount > 0) { %>
                                            <tr>
                                                <td colspan="4" class="text-end"><strong>Discount:</strong></td>
                                                <td><strong>&#8377;<%= order.discountAmount.toFixed(2) %></strong></td>
                                            </tr>
                                            <tr class="table-primary">
                                                <td colspan="4" class="text-end"><strong>Total Amount:</strong></td>
                                                <td><strong>&#8377;<%= (order.totalAmount - order.discountAmount).toFixed(2) %></strong></td>
                                            </tr>
                                        <% } else { %>
                                            <tr class="table-primary">
                                                <td colspan="4" class="text-end"><strong>Total Amount:</strong></td>
                                                <td><strong>&#8377;<%= order.totalAmount.toFixed(2) %></strong></td>
                                            </tr>
                                        <% } %>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                
<!--------------- ejs content end here -----------------------------------------------------content end here------------------------------------------------------------------------------------------------>
            </div>
        </div>
    </div>
</div>
            
<!-- retry payment start here ---------------------------------------------------------------->
<script>
 
    
    function retry_payment(orderId) {
        console.log("orderid");
        
        fetch('/retry-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ orderId: orderId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Initialize Razorpay payment
                var options = {
                    key: data.key_id,
                    amount: data.amount,
                    currency: data.currency,
                    name: "EYEGAZE",
                    description: "Order Payment",
                    order_id: data.order_id,
                    handler: function (response) {
                        fetch('/update-payment-status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                orderId: orderId,
                                paymentMethod: 'razorpay',
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_order_id: response.razorpay_order_id
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href ='/orders'
                            } else {
                                window.location.href = `/placeorder?id=${data.orderId}`;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while updating payment status.');
                        });
                    },
                    prefill: {
                        name: "EYEGAZE",
                        email: "eyegazefit@gmail.com",
                        contact: "9001 7001 78"
                    },
                    theme: {
                        color: "#F37254"
                    }
                };
                var rzp1 = new Razorpay(options);
                rzp1.open();
            } else {
                alert(data.message || 'Error creating Razorpay order.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while retrying payment.');
        });
    }
    
     </script>
    
    
    
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
           
                    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
                    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
                  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
                  
                  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="/js/jquery.min.js"></script>
<!-- popper -->
<script src="/js/popper.min.js"></script>
<!-- bootstrap 4.1 -->
<script src="/js/bootstrap.min.js"></script>
<!-- jQuery easing -->
<script src="/js/jquery.easing.1.3.js"></script>
<!-- Waypoints -->
<script src="/js/jquery.waypoints.min.js"></script>
<!-- Flexslider -->
<script src="/js/jquery.flexslider-min.js"></script>
<!-- Owl carousel -->
<script src="/js/owl.carousel.min.js"></script>
<!-- Magnific Popup -->
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/magnific-popup-options.js"></script>
<!-- Date Picker -->

<!-- Main -->
<script src="/js/main.js"></script>
<%- include('../partials/footer') %>