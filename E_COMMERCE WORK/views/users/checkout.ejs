<%- include('../partials/header') %>


<style>

     .modal-header {
    border-bottom: none;
  }
  
  .modal-footer {
    border-top: none;
  }
  
  .coupon-list {
    max-height: 300px;
    overflow-y: auto;
  }
  
  .coupon-item {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
  }
  
  .coupon-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  
  .coupon-code {
    font-size: 1.2em;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 5px;
  }
  
  .coupon-description {
    font-size: 0.9em;
    color: #6c757d;
    margin-bottom: 10px;
  }
  
  .copy-btn {
    float: right;
  }
    /* Style for the address boxes */
    .address-box {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .address-box input[type="radio"] {
        margin-right: 10px;
        cursor: pointer;
    }

    .address-details p {
        margin: 0;
    }

    /* Style for the 'Add New Address' link */
    .add-new-address {
        text-align: center;
        margin-top: 20px;
    }

    .add-new-address a {
        color: #007bff;
        text-decoration: none;
        font-weight: bold;
    }

    .add-new-address a:hover {
        text-decoration: underline;
    }

    /* Style for the address boxes */
    .address-box {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .address-box input[type="radio"] {
        margin-right: 15px;
        cursor: pointer;
        accent-color: #007bff;
        /* For modern browsers with support for accent-color */
    }

    .address-details p {
        margin: 0;
        font-size: 16px;
        line-height: 1.6;
        color: #333;
    }

    .address-details p:first-child {
        font-weight: bold;
    }

    /* Style for the 'Add New Address' link */
    .add-new-address {
        text-align: center;
        margin-top: 20px;
    }

    .add-new-address a {
        color: #007bff;
        text-decoration: none;
        font-weight: bold;
        font-size: 16px;
    }

    .add-new-address a:hover {
        text-decoration: underline;
        color: #0056b3;
    }
    .cart-detail {
border: 1px solid #ddd;
padding: 20px;
border-radius: 8px;
background-color: #f9f9f9;
box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.cart-detail h2 {
font-size: 24px;
margin-bottom: 15px;
color: #333;
}

.cart-summary {
list-style-type: none;
padding: 0;
margin: 0;
}

.cart-item {
display: flex;
justify-content: space-between;
padding: 10px 0;
border-bottom: 1px solid #eee;
}

.cart-item:last-child {
border-bottom: none;
}

.product-list {
list-style-type: none;
padding: 0;
margin: 0;
}

.product-list li {
display: flex;
justify-content: space-between;
padding: 5px 0;
}

.free-shipping {
color: #28a745; /* Green color for free shipping */
font-weight: bold;
}
.coupon-section {
                        margin-bottom: 20px;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        background-color: #f9f9f9;
                    }
                    
                    .coupon-input {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    
                    #coupon-code {
                        flex: 1;
                        padding: 5px;
                        border: 1px solid #ccc;
                        border-radius: 4px;
                    }
                    .coupon-section {
    background-color: #f8f9fa;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.coupon-section:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.card-title {
    color: #333;
    font-weight: bold;
}

.input-group {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#coupon-code {
    border: none;
    padding: 10px 15px;
}

.apply-coupon-btn {
    background-color: #007bff;
    border: none;
    padding: 10px 20px;
    transition: background-color 0.3s ease;
}

.apply-coupon-btn:hover {
    background-color: #0056b3;
}

.show-coupons-btn {
    border: 2px dashed #6c757d;
    padding: 10px;
    transition: all 0.3s ease;
}

.show-coupons-btn:hover {
    background-color: hsl(204, 13%, 8%);
    color: white;
    
}
.coupon-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .coupon-section:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .card-title {
        color: #333;
        font-weight: bold;
    }

    .input-group {
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        position: relative;
    }

    #coupon-code {
        border: none;
        padding: 10px 15px;
        padding-right: 80px; /* Make space for the button */
    }

    .input-group-append {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
    }

    .apply-coupon-btn {
        background-color: #007bff;
        border: none;
        padding: 5px 15px;
        transition: background-color 0.3s ease;
    }

    .apply-coupon-btn:hover {
        background-color: #0056b3;
    }

    .show-coupons-btn {
        border: 2px dashed #6c757d;
        padding: 10px;
        transition: all 0.3s ease;
    }

    .show-coupons-btn:hover {
        background-color: #6c757d;
        color: white;
    }

</style>


    <div class="colorlib-loader"></div>

    <div id="page">
        <nav class="colorlib-nav" role="navigation">
            <div class="top-menu">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-7 col-md-9">
                            <div id="colorlib-logo"><a href="/product">EYEGAZE</a></div>
                        </div>
                        
                 </div>
                    <div class="row">
                        <div class="col-sm-12 text-left menu-1">
                            <ul>
                            
                            
                                    <li class="cart"><a href="/myaccount">my account</a></li>
                            
                                    
                            
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sale">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-8 offset-sm-2 text-center">
                            <div class="row">
                                <div class="owl-carousel2">
                                    <div class="item">
                                        <div class="col">
                                            <h3><a href="/cart">click here for cart</a></h3>
                                        </div>
                                    </div>
                                    <div class="item">
                                        <div class="col">
                                            <h3><a href="/cart">see your for cart</a></h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- content start here -->

        <div class="breadcrumbs">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <p class="bread"><span><a href="index.html">Home</a></span> / <span>Checkout</span></p>
                    </div>
                </div>
            </div>
        </div>


        <div class="colorlib-product">
            <div class="container">
                <!-- <div class="row row-pb-lg">
                <div class="col-sm-10 offset-md-1">
                    <div class="process-wrap">
                        <div class="process text-center active">
                            <p><span>01</span></p>
                            <h3>Shopping Cart</h3>
                        </div>
                        <div class="process text-center active">
                            <p><span>02</span></p>
                            <h3>Checkout</h3>
                        </div>
                        <div class="process text-center">
                            <p><span>03</span></p>
                            <h3>Order Complete</h3>
                        </div>
                    </div>
                </div>
            </div> -->
                <div class="row">
                    <div class="col-lg-8">
                       
                        <div class="coupon-section card shadow-sm p-4 mb-4">
                            
                            <h5 class="card-title mb-3">Discount Coupons</h5>
                            <form id="couponForm" class="mb-3">
                                <div class="input-group">
                                    <input type="text" id="coupon-code" name="couponCode" class="form-control" placeholder="Enter coupon code" required>
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-primary apply-coupon-btn">Apply</button>
                                        <button type="button" id="removeCouponBtn" class="btn btn-danger">Remove</button>
                                    </div>
                                </div>
                            </form>
                            <div class="error-message mb-3" id="message">
                               
                            </div>
                            <button type="button" class="btn btn-outline-secondary show-coupons-btn w-100" data-toggle="modal" data-target="#myModal">
                                <i class="fas fa-tags me-2"></i>Show All Available Coupons
                            </button>
                        </div>
                        
                        <h2>Select an Address</h2>
                        <div class="add-new-address">
                            <a href="/address">Add New Address</a>
                        </div>
                        <% address.forEach(function(addr, index) { %>
                            <div class="address-box">
                                <input type="radio" name="address" value="<%= addr._id %>">
                                <div class="address-details">
                                    <p><strong>
                                            <%= addr.addressName %>
                                        </strong></p>
                                    <p>
                                        <%= addr.addressHouse %>, <%= addr.addressStreet %>
                                    </p>
                                    <p>
                                        <%= addr.addressCity %>, <%= addr.addressDistrict %>
                                    </p>
                                    <p>
                                        <%= addr.addressState %> - <%= addr.addressPin %>
                                    </p>
                                    <p>Email: <%= addr.addressEmail %>
                                    </p>
                                    <p>Mobile: <%= addr.addressMobile %>
                                    </p>
                                </div>
                            </div>
                            <% }) %>


                    </div>


                    <div class="col-lg-4">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="cart-detail">
                                    <h2>Cart Total</h2>
                                    <ul class="cart-summary">
                                        <li class="cart-item">
                                            <ul class="product-list">
                                                <% if (cart && cart.products.length > 0) { %>
                                                    <% cart.products.forEach(item => { %>
                                                        <li>
                                                            <span><%= item.quantity %> x <%= item.product.productName %></span>
                                                            <span>&#8377;<%= item.discountPrice ? item.discountPrice.toFixed(2) : item.product.price.toFixed(2) %></span>
                                                        </li>
                                                    <% }) %>
                                               
                                                <% } %>
                                            </ul>
                                        </li>
                                        <li class="cart-item">
                                            <span>Shipping</span> <span class="free-shipping">Free</span>
                                        </li>
                                        <li class="cart-item">
                                            <span>Order Total</span> <span>&#8377;<%= totalCartAmount.toFixed(2) %></span>
                                        </li>
                                        <li class="discount-item" style="display: none;">
                                            <span>coupon discount</span> <span class="discount-amount">&#8377;</span>
                                        </li>
                                        <li class="subtotal-item" style="display: none;">
                                            <span>subtotal</span> <span class="subtotal-amount">&#8377;</span>
                                        </li>
                                    </ul>
                                  
                                </div>
                            </div>
                            

                            <div class="w-100"></div>

                            <div class="col-md-12">
                                <div class="cart-detail">
                                    <h2>Payment Method</h2>
                                    <!-- <div class="form-group">
                                    <div class="col-md-12">
                                        <div class="radio">
                                           <label><input type="radio" name="optradio"> Direct Bank Tranfer</label>
                                        </div>
                                    </div>
                                </div> -->
                                    <div class="form-group">
                                    <div class="col-md-12">
                                        <div class="radio">
                                           <label><input type="radio" name="optradio" value="razorpay"> online payment</label>
                                        </div>
                                    </div>
                                </div>
                                    <div class="form-group">
                                        <div class="col-md-12">
                                            <div class="radio">
                                                <label><input type="radio" name="optradio" value="cod"> COD</label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- <div class="form-group">
                                    <div class="col-md-12">
                                        <div class="checkbox">
                                           <label><input type="checkbox" value=""> I have read and accept the terms and conditions</label>
                                        </div>
                                    </div>
                                </div> -->
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 text-center">
                                <p><button class="btn btn-primary" id="placeOrderBtn">Place an order</button> </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- content end here -->

        <!-- modal for show coupon -------------------------------------------------------------------------------------------------->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="couponModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title" id="couponModalLabel">Available Coupon Codes</h5>
                  <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="coupon-list">
                    <% if (coupon && coupon.length > 0) { %>
                        <% coupon.forEach((coup) => { %>
                            <div class="coupon-item">
                                <div class="coupon-code"><%= coup.code %></div>
                                <button class="btn btn-sm btn-outline-primary copy-btn" data-coupon="<%= coup.code %>">Copy Code</button>
                                <span>just click the copycode and use it</span>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p>No coupons available at this time.</p>
                    <% } %>
                    
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
          
<script>
document.getElementById('couponForm').addEventListener('submit', async function(e) {
    e.preventDefault(); 

    const couponCode = document.getElementById('coupon-code').value;
    
    try {
        const response = await fetch('/apply-coupon', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ couponCode })
        });

        const result = await response.json();
console.log(result);

        if (response.ok) {
          
          
            
            document.querySelector('.discount-item').style.display = 'block';
            document.querySelector('.subtotal-item').style.display = 'block';
            
            document.querySelector('.discount-amount').innerHTML = `&#8377;${parseFloat(result.discountAmount).toFixed(2)}`;
document.querySelector('.subtotal-amount').innerHTML = `&#8377;${parseFloat(result.totalCartAmount).toFixed(2)}`;
 

        } else {
            document.getElementById('message').textContent = result.message;
            document.getElementById('message').style.color = 'red';
            document.querySelector('.discount-item').style.display = 'none';
            document.querySelector('.subtotal-item').style.display = 'none';
        }
    } catch (error) {
        console.error('Error applying coupon:', error);
        document.getElementById('message').textContent = 'There was an error applying the coupon. Please try again.';
        document.getElementById('message').style.color = 'red';
           document.querySelector('.discount-item').style.display = 'none';
            document.querySelector('.subtotal-item').style.display = 'none';
    }
});


document.getElementById('removeCouponBtn').addEventListener('click', function() {
    document.getElementById('coupon-code').value = '';
    
    document.querySelector('.discount-item').style.display = 'none';
    document.querySelector('.subtotal-item').style.display = 'none';
});



</script>
       

   
<script>
    
    document.getElementById('placeOrderBtn').addEventListener('click', async function (event) {
event.preventDefault();

const paymentMethod = document.querySelector('input[name="optradio"]:checked').value;
const addressId = document.querySelector('input[name="address"]:checked').value;
const coupon_code=document.getElementById('coupon-code').value




if (paymentMethod === 'razorpay') {
    try {
        // First, create a Razorpay order
        const razorpayOrderResponse = await fetch('/place-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                paymentMethod: paymentMethod,
                addressId: addressId,
                coupon: coupon_code
            })
        });
        
        const razorpayOrderData = await razorpayOrderResponse.json();
        const discountAmount = razorpayOrderData.discountAmount;
        const discountPercentage = razorpayOrderData.discountPercentage;
const couponApplied=razorpayOrderData.couponApplied

        if (razorpayOrderData.success) {
            // Proceed with Razorpay payment
            var options = {
                key: razorpayOrderData.key_id,
                amount: razorpayOrderData.amount,
                currency: razorpayOrderData.currency,
                name: "EYEGAZE",
                description: "Test Transaction",
                order_id: razorpayOrderData.order_id,
                handler: function (response) {
                    // On successful payment, send payment details to the backend
                    fetch('/place-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            paymentMethod: paymentMethod,
                            addressId: addressId,
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            couponDiscountPercentage: discountPercentage,
                            couponDiscountAmount: discountAmount,
                            couponid:couponApplied
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = data.redirect;
                        } else {
                            alert('Error placing order: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                },
                prefill: {
                    name: "EYEGAZE",
                    email: "eyegazefit@gmail.com",
                    contact: "9001 7001 78"
                },
                theme: {
                    color: "#F37254"
                }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
        } else {
            alert('Error creating Razorpay order: ' + razorpayOrderData.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
} else if (paymentMethod === 'cod') {
    // COD payment, directly place the order
    fetch('/place-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            paymentMethod: paymentMethod,
            addressId: addressId,
            coupon: coupon_code
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            alert('Error placing order: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
});

</script>
<!-- copy code -->
<script>
    document.querySelectorAll('.copy-btn').forEach(button => {
      button.addEventListener('click', function() {
        const couponCode = this.getAttribute('data-coupon');
        navigator.clipboard.writeText(couponCode).then(() => {
          // Change button text temporarily
          const originalText = this.textContent;
          this.textContent = 'Copied!';
          setTimeout(() => {
            this.textContent = originalText;
          }, 2000);
        });
      });
    });
    </script>
    
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/jquery.min.js"></script>
    <!-- popper -->
    <script src="/js/popper.min.js"></script>
    <!-- bootstrap 4.1 -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- jQuery easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- Flexslider -->
    <script src="/js/jquery.flexslider-min.js"></script>
    <!-- Owl carousel -->
    <script src="/js/owl.carousel.min.js"></script>
    <!-- Magnific Popup -->
    <script src="/js/jquery.magnific-popup.min.js"></script>
    <script src="/js/magnific-popup-options.js"></script>
    <!-- Date Picker -->

    <!-- Main -->
    <script src="/js/main.js"></script>

    <%- include('../partials/footer') %>

  
    
   
      
        <!-- Modal -->
        
     